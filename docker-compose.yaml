services:
  app:
    build: .
    container_name: egzamin-app
    environment:
      APP_ENV: production
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      APP_TIMEZONE: ${APP_TIMEZONE}
      OPENAI_MODEL: ${OPENAI_MODEL}
      OPENAI_MAX_COMPLETION_TOKENS: ${OPENAI_MAX_COMPLETION_TOKENS}
      OPENAI_TEMPERATURE: ${OPENAI_TEMPERATURE}
    ports:
      - "127.0.0.1:8081:80"
    volumes:
      - ./server/storage:/var/www/server/storage
    tmpfs:
      - /ramdisk_tmpfs:size=5m
    restart: unless-stopped
    command: >
      bash -lc '
        echo "[ENTRYPOINT] Preparing writable dirs..." &&
        mkdir -p /var/www/server/storage /ramdisk_tmpfs &&
        chown -R www-data:www-data /var/www/server/storage /ramdisk_tmpfs || true &&
        chmod 770 /ramdisk_tmpfs || true &&
        echo "[ENTRYPOINT] Dirs ready, starting Apache" &&
        exec apache2-foreground
      '
